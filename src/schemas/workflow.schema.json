{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "workflow.schema.json",
  "title": "WorkflowManifest",
  "type": "object",
  "required": ["id", "label", "hooks"],
  "properties": {
    "id": {
      "$ref": "#/$defs/nonEmptyString"
    },
    "label": {
      "$ref": "#/$defs/nonEmptyString"
    },
    "provider": {
      "$ref": "#/$defs/nonEmptyString"
    },
    "version": {
      "$ref": "#/$defs/nonEmptyString"
    },
    "parameters": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/parameterSchema"
      }
    },
    "inputs": {
      "$ref": "#/$defs/inputsSpec"
    },
    "execution": {
      "$ref": "#/$defs/executionSpec"
    },
    "result": {
      "$ref": "#/$defs/resultSpec"
    },
    "request": {
      "$ref": "#/$defs/requestSpec"
    },
    "hooks": {
      "$ref": "#/$defs/hooksSpec"
    },
    "backend": false,
    "defaults": false
  },
  "additionalProperties": true,
  "$defs": {
    "nonEmptyString": {
      "type": "string",
      "minLength": 1
    },
    "parameterSchema": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean"]
        },
        "title": {
          "type": "string"
        },
        "description": {
          "type": "string"
        },
        "default": {},
        "enum": {
          "type": "array",
          "minItems": 1,
          "items": {}
        },
        "allowCustom": {
          "type": "boolean"
        },
        "min": {
          "type": "number"
        },
        "max": {
          "type": "number"
        }
      },
      "allOf": [
        {
          "if": {
            "type": "object",
            "required": ["min", "max"],
            "properties": {
              "min": {
                "type": "number"
              },
              "max": {
                "type": "number"
              }
            }
          },
          "then": {
            "properties": {
              "min": {
                "type": "number",
                "maximum": {
                  "$data": "1/max"
                }
              }
            }
          }
        }
      ],
      "additionalProperties": true
    },
    "hooksSpec": {
      "type": "object",
      "required": ["applyResult"],
      "properties": {
        "filterInputs": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "buildRequest": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "normalizeSettings": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "applyResult": {
          "$ref": "#/$defs/nonEmptyString"
        }
      },
      "additionalProperties": false
    },
    "inputsSpec": {
      "type": "object",
      "required": ["unit"],
      "properties": {
        "unit": {
          "type": "string",
          "enum": ["attachment", "parent", "note"]
        },
        "accepts": {
          "type": "object",
          "properties": {
            "mime": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": false
        },
        "per_parent": {
          "type": "object",
          "properties": {
            "min": {
              "type": "number"
            },
            "max": {
              "type": "number"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "executionSpec": {
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["auto", "sync", "async"]
        },
        "poll_interval_ms": {
          "type": "number"
        },
        "timeout_ms": {
          "type": "number"
        },
        "feedback": {
          "$ref": "#/$defs/executionFeedbackSpec"
        }
      },
      "additionalProperties": false
    },
    "executionFeedbackSpec": {
      "type": "object",
      "properties": {
        "showNotifications": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "resultSpec": {
      "type": "object",
      "properties": {
        "fetch": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["bundle", "result"]
            }
          },
          "additionalProperties": false
        },
        "expects": {
          "type": "object",
          "properties": {
            "result_json": {
              "$ref": "#/$defs/nonEmptyString"
            },
            "artifacts": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "requestSpec": {
      "type": "object",
      "required": ["kind"],
      "properties": {
        "kind": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "create": {
          "$ref": "#/$defs/requestCreateSpec"
        },
        "input": {
          "$ref": "#/$defs/requestInputSpec"
        },
        "poll": {
          "$ref": "#/$defs/requestPollSpec"
        },
        "result": false
      },
      "additionalProperties": true
    },
    "requestCreateSpec": {
      "type": "object",
      "properties": {
        "skill_id": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "engine": false,
        "parameter": false,
        "model": false,
        "runtime_options": false
      },
      "additionalProperties": true
    },
    "requestInputSpec": {
      "type": "object",
      "properties": {
        "upload": {
          "type": "object",
          "properties": {
            "files": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/requestUploadFileSpec"
              }
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": true
    },
    "requestUploadFileSpec": {
      "type": "object",
      "required": ["key", "from"],
      "properties": {
        "key": {
          "$ref": "#/$defs/nonEmptyString"
        },
        "from": {
          "type": "string",
          "enum": ["selected.markdown", "selected.pdf"]
        }
      },
      "additionalProperties": false
    },
    "requestPollSpec": {
      "type": "object",
      "properties": {
        "interval_ms": {
          "type": "number"
        },
        "timeout_ms": {
          "type": "number"
        }
      },
      "additionalProperties": true
    }
  }
}
